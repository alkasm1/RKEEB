<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>تحليل نسيج الورق المباشر</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f0f4f8;
      text-align: center;
      padding: 20px;
      direction: rtl;
    }
    canvas {
      border: 2px solid #ccc;
      margin-top: 20px;
    }
    button {
      font-size: 18px;
      padding: 10px 25px;
      background-color: #0275d8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    #result {
      margin-top: 20px;
      font-weight: bold;
      color: #333;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <h2>📸 تصوير مباشر وتحليل نسيج ورقي دقيق</h2>
  <button onclick="captureComparison()">بدء التصوير</button>
  <canvas id="compareCanvas" width="500" height="250"></canvas>
  <div id="result">📊 النتيجة ستظهر هنا بعد التصوير...</div>

  <script>
    function captureComparison() {
      const canvas = document.getElementById('compareCanvas');
      const ctx = canvas.getContext('2d');
      const resultDiv = document.getElementById('result');
      resultDiv.textContent = '🔍 جاري الالتقاط والتحليل...';

      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          const video = document.createElement('video');
          video.srcObject = stream;
          video.play();

          video.onloadeddata = () => {
            // تصوير منطقتين منفصلتين
            ctx.drawImage(video, 80, 120, 200, 200, 0, 0, 200, 200);   // الورقة A
            ctx.drawImage(video, 320, 120, 200, 200, 300, 0, 200, 200); // الورقة B
            stream.getTracks().forEach(track => track.stop());

            // استخراج بيانات الصورة
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const grayData = [];

            for (let i = 0; i < imgData.data.length; i += 4) {
              const r = imgData.data[i];
              const g = imgData.data[i + 1];
              const b = imgData.data[i + 2];
              const gray = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
              grayData.push(gray);
            }

            // فصل بيانات المنطقتين
            const patchA = grayData.slice(0, 200 * 200);
            const patchB = grayData.slice(200 * 200, 400 * 200);
            const similarity = compareTexture(patchA, patchB);

            resultDiv.textContent = `✅ نسبة التطابق النسيجي: ${similarity.toFixed(2)}٪`;
          };
        })
        .catch(error => {
          resultDiv.textContent = `❌ خطأ في الوصول للكاميرا: ${error.message}`;
        });
    }

    function compareTexture(a, b) {
      let sumDiff = 0;
      for (let i = 0; i < a.length; i++) {
        sumDiff += Math.abs(a[i] - b[i]);
      }
      const avgDiff = sumDiff / a.length;
      const similarity = 100 - ((avgDiff / 255) * 100); // نسبة عكسية
      return similarity;
    }
  </script>
</body>
</html>
