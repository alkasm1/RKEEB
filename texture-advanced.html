<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>تحليل النسيج المتقدم</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; direction: rtl; text-align: center; background: #f4f4f4; padding: 20px; }
    h1 { color: #444; }
    input, progress { margin: 15px; padding: 10px; font-size: 1rem; }
    #resultMessage { margin-top: 20px; font-size: 1.2rem; color: #333; }
    button { padding: 10px 20px; font-size: 1rem; background: #2e86de; color: white; border: none; cursor: pointer; border-radius: 5px; }
    button:hover { background: #1e5f9c; }
  </style>
</head>
<body>
  <h1>🔍 صفحة تحليل النسيج المتقدم</h1>
  <input type="file" accept="image/*" id="imageInput">
  <button onclick="startAnalysis()">ابدأ التحليل</button>
  <progress id="matchProgress" value="0" max="100"></progress>
  <div id="resultMessage">⚠️ يرجى تحميل صورة</div>

  <script>
    async function analyzeSingleImage(file) {
      const result = document.getElementById('resultMessage');
      const progress = document.getElementById('matchProgress');

      if (!file) {
        result.innerText = "⚠️ يرجى اختيار صورة تحتوي الأصل والمُشتبه به معًا";
        return;
      }

      result.innerText = "⏳ جاري التحليل...";

      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.src = reader.result;

        img.onload = async () => {
          const canvasLeft = document.createElement("canvas");
          const canvasRight = document.createElement("canvas");

          const halfWidth = img.width / 2;
          const height = img.height;

          [canvasLeft, canvasRight].forEach(c => {
            c.width = 300;
            c.height = 300;
          });

          const ctxLeft = canvasLeft.getContext("2d");
          const ctxRight = canvasRight.getContext("2d");

          ctxLeft.drawImage(img, 0, 0, halfWidth, height, 0, 0, 300, 300);
          ctxRight.drawImage(img, halfWidth, 0, halfWidth, height, 0, 0, 300, 300);

          const materialMatch = evaluateMaterialMatch(canvasLeft, canvasRight);
          if (materialMatch < 80) {
            result.innerText = `❌ اختلاف في نوع المادة (${materialMatch}%) - لا يمكن إجراء مقارنة موثوقة`;
            progress.value = materialMatch;
            return;
          }

          const blobLeft = await new Promise(res => canvasLeft.toBlob(res, 'image/png'));
          const blobRight = await new Promise(res => canvasRight.toBlob(res, 'image/png'));

          const hashLeft = await calculateHash(blobLeft);
          const hashRight = await calculateHash(blobRight);

          const percent = calculateSimilarity(hashLeft, hashRight);
          progress.value = percent;

          if (percent >= 90) result.innerText = `✅ تطابق ${percent}% - مطابق تمامًا`;
          else if (percent >= 70) result.innerText = `⚠️ تطابق ${percent}% - تحقق يدوي`;
          else result.innerText = `❌ تطابق ${percent}% - محتمل تزوير`;
        };
      };
      reader.readAsDataURL(file);
    }

    function startAnalysis() {
      const input = document.getElementById('imageInput');
      analyzeSingleImage(input.files[0]);
    }

    // دوال محاكاة افتراضية: replace with actual logic
    function evaluateMaterialMatch(c1, c2) {
      return Math.floor(Math.random() * 40) + 60; // نسبة عشوائية بين 60 و100
    }

    async function calculateHash(blob) {
      const buffer = await blob.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function calculateSimilarity(hash1, hash2) {
      let matches = 0;
      for (let i = 0; i < Math.min(hash1.length, hash2.length); i++) {
        if (hash1[i] === hash2[i]) matches++;
      }
      return Math.round((matches / hash1.length) * 100);
    }
  </script>
</body>
</html>
