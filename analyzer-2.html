<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØªØ­Ù„ÙŠÙ„ Ù†Ø³ÙŠØ¬ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; text-align: center; direction: rtl; }
    video, canvas, button { max-width: 400px; width: 90%; margin: 10px auto; display: block; }
    button { font-size: 16px; padding: 10px; border: none; background: #008080; color: white; border-radius: 6px; cursor: pointer; }
    #matchCanvas { border: 2px dashed #444; height: 150px; }
  </style>
</head>
<body>

  <h2>ğŸ§ª ØªØ­Ù„ÙŠÙ„ Ù†Ø³ÙŠØ¬ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ Ø¹Ø¨Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h2>
  <video id="video" autoplay playsinline></video>
  <button onclick="captureAndAnalyze()">ğŸ¯ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <canvas id="matchCanvas" width="300" height="150"></canvas>
  <div id="result">ğŸ“Œ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù„ÙŠÙ„</div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const matchCanvas = document.getElementById("matchCanvas");
    const resultDiv = document.getElementById("result");

    async function openCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" }, audio: false
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => video.play();
      } catch (err) {
        alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
      }
    }

    window.onload = openCamera;

    function captureAndAnalyze() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const gray = toGrayscale(imageData);
      const blocks = extractBlocks(gray, canvas.width, canvas.height);

      const [blockA, blockB, score] = findMostSimilarPair(blocks);
      drawMatchingBlocks(blockA, blockB);
      resultDiv.innerText = `âœ… Ù†Ø³Ø¨Ø© ØªØ·Ø§Ø¨Ù‚ Ù†Ø³ÙŠØ¬ÙŠ: ${score.toFixed(2)} / 256`;
    }

    function toGrayscale(imageData) {
      const pixels = imageData.data;
      const gray = [];
      for (let i = 0; i < pixels.length; i += 4) {
        const g = (pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3;
        gray.push(Math.round(g));
      }
      return gray;
    }

    function extractBlocks(gray, width, height) {
      const blockSize = 40;
      const blocks = [];
      for (let y = 0; y < height - blockSize; y += blockSize) {
        for (let x = 0; x < width / 2 - blockSize; x += blockSize) {
          blocks.push({
            x, y, w: blockSize, h: blockSize, side: "left",
            data: getBlockData(gray, x, y, blockSize, width)
          });
        }
        for (let x = Math.floor(width / 2); x < width - blockSize; x += blockSize) {
          blocks.push({
            x, y, w: blockSize, h: blockSize, side: "right",
            data: getBlockData(gray, x, y, blockSize, width)
          });
        }
      }
      return blocks;
    }

    function getBlockData(gray, x, y, size, imgWidth) {
      const block = [];
      for (let j = 0; j < size; j++) {
        for (let i = 0; i < size; i++) {
          block.push(gray[(y + j) * imgWidth + (x + i)]);
        }
      }
      return block;
    }

    function computeGLCM(data) {
      const glcm = Array.from({ length: 256 }, () => Array(256).fill(0));
      for (let i = 0; i < data.length - 1; i++) {
        const a = data[i];
        const b = data[i + 1];
        glcm[a][b]++;
      }
      return glcm;
    }

    function compareGLCM(glcmA, glcmB) {
      let score = 0;
      for (let i = 0; i < 256; i++) {
        for (let j = 0; j < 256; j++) {
          score += 1 - Math.abs(glcmA[i][j] - glcmB[i][j]) / Math.max(glcmA[i][j] + glcmB[i][j], 1);
        }
      }
      return score;
    }

    function findMostSimilarPair(blocks) {
      let bestScore = -Infinity;
      let pair = [null, null];
      const lefts = blocks.filter(b => b.side === "left");
      const rights = blocks.filter(b => b.side === "right");

      for (let a of lefts) {
        for (let b of rights) {
          const glcmA = computeGLCM(a.data);
          const glcmB = computeGLCM(b.data);
          const score = compareGLCM(glcmA, glcmB);
          if (score > bestScore) {
            bestScore = score;
            pair = [a, b];
          }
        }
      }
      return [pair[0], pair[1], bestScore];
    }

    function drawMatchingBlocks(a, b) {
      const ctx = matchCanvas.getContext("2d");
      const img = ctx.createImageData(a.w, a.h);
      for (let i = 0; i < a.data.length; i++) {
        const val = a.data[i];
        img.data[i * 4] = val;
        img.data[i * 4 + 1] = val;
        img.data[i * 4 + 2] = val;
        img.data[i * 4 + 3] = 255;
      }
      ctx.putImageData(img, 0, 0);

      const img2 = ctx.createImageData(b.w, b.h);
      for (let i = 0; i < b.data.length; i++) {
        const val = b.data[i];
        img2.data[i * 4] = val;
        img2.data[i * 4 + 1] = val;
        img2.data[i * 4 + 2] = val;
        img2.data[i * 4 + 3] = 255;
      }
      ctx.putImageData(img2, a.w + 20, 0);
    }
  </script>
</body>
</html>
