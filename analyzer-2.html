async function startSingleImageAnalysis() {
  const file = document.getElementById("imageFile").files[0];
  if (!file) return alert("يرجى اختيار صورة أولاً.");

  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  const resultBox = document.getElementById("resultBox");

  progressBar.value = 10;
  progressText.textContent = "10% - جاري التحميل...";

  const imageCanvas = await loadImageToCanvas(file);

  progressBar.value = 20;
  progressText.textContent = "20% - استخراج منطقتين للتحليل...";

  const regions = splitCanvas(imageCanvas);
  const [originalRegion, suspectRegion] = regions;

  const region1 = convertToGrayscale(originalRegion);
  const region2 = convertToGrayscale(suspectRegion);

  progressBar.value = 35;
  progressText.textContent = "35% - تحليل الملمس (Gabor)...";
  const textureScore = analyzeGaborTexture(region1, region2);

  progressBar.value = 50;
  progressText.textContent = "50% - تحليل التردد...";
  const freqScore = analyzeFrequency(region1, region2);

  progressBar.value = 65;
  progressText.textContent = "65% - تحليل الألوان...";
  const colorScore = analyzeColorSimilarity(originalRegion, suspectRegion); // استخدم النسخة الملونة

  progressBar.value = 75;
  progressText.textContent = "75% - تحليل الضوضاء...";
  const noiseScore = analyzeNoise(region1, region2);

  progressBar.value = 85;
  progressText.textContent = "85% - مقارنة مباشرة للبكسلات...";
  const pixelDiff = simplePixelDiff(region1, region2);
  const pixelScore = Math.max(0, 100 - (pixelDiff / 50) * 100);

  progressBar.value = 95;
  progressText.textContent = "95% - إنشاء صورة الفروقات...";
  const diffImageDataURL = createDiffImage(region1, region2);

  // حساب الدرجة النهائية
  const textureWeight = 0.25;
  const freqWeight = 0.25;
  const colorWeight = 0.25;
  const noiseWeight = 0.25;

  const score = (
    (textureScore * textureWeight) +
    (freqScore * freqWeight) +
    (colorScore * colorWeight) +
    (noiseScore * noiseWeight) +
    (pixelScore * 0.25)
  ) / 1.25;

  progressBar.value = 100;
  progressText.textContent = `${score.toFixed(1)}%`;

  resultBox.innerHTML = `
    <h2>نتيجة التحليل: ${score.toFixed(1)}%</h2>
    <p>${score < 60 ? '⚠️ المستند المشكوك فيه يبدو مختلفًا بشكل كبير عن الأصلي. احتمال التزوير مرتفع.' : '✅ لا توجد اختلافات جوهرية، المستند يبدو سليمًا.'}</p>
    <hr>
    <h3><i class="fas fa-chart-bar"></i> تفاصيل التحليل:</h3>
    <ul>
      <li>تحليل الملمس (Gabor): ${textureScore.toFixed(1)}%</li>
      <li>تحليل التردد: ${freqScore.toFixed(1)}%</li>
      <li>تحليل الألوان: ${colorScore.toFixed(1)}%</li>
      <li>تحليل الضوضاء: ${noiseScore.toFixed(1)}%</li>
      <li>مقارنة البكسلات: ${pixelScore.toFixed(1)}%</li>
    </ul>
    <h3 style="margin-top: 2rem;"><i class="fas fa-eye"></i> معاينة الفروقات البصرية:</h3>
    <div class="image-preview" style="margin-top: 1rem;">
      <img src="${diffImageDataURL}" alt="صورة الفروقات">
      <p>المناطق باللون الأحمر تمثل اختلافات واضحة بين المستندين</p>
    </div>
  `;
}

// ✅ مقارنة البكسلات مباشرة
function simplePixelDiff(canvas1, canvas2) {
  const ctx1 = canvas1.getContext("2d");
  const ctx2 = canvas2.getContext("2d");
  const data1 = ctx1.getImageData(0, 0, canvas1.width, canvas1.height).data;
  const data2 = ctx2.getImageData(0, 0, canvas2.width, canvas2.height).data;

  let totalDiff = 0;
  for (let i = 0; i < data1.length; i += 4) {
    const gray1 = (data1[i] + data1[i + 1] + data1[i + 2]) / 3;
    const gray2 = (data2[i] + data2[i + 1] + data2[i + 2]) / 3;
    totalDiff += Math.abs(gray1 - gray2);
  }

  return totalDiff / (data1.length / 4); // متوسط الفرق
}

// ✅ إنشاء صورة الفرق (Diff Image)
function createDiffImage(canvas1, canvas2) {
  const width = canvas1.width;
  const height = canvas1.height;

  const outputCanvas = document.createElement('canvas');
  outputCanvas.width = width;
  outputCanvas.height = height;

  const ctx1 = canvas1.getContext('2d');
  const ctx2 = canvas2.getContext('2d');
  const outCtx = outputCanvas.getContext('2d');

  const data1 = ctx1.getImageData(0, 0, width, height).data;
  const data2 = ctx2.getImageData(0, 0, width, height).data;

  const output = outCtx.createImageData(width, height);

  for (let i = 0; i < data1.length; i += 4) {
    const gray1 = (data1[i] + data1[i + 1] + data1[i + 2]) / 3;
    const gray2 = (data2[i] + data2[i + 1] + data2[i + 2]) / 3;
    const diff = Math.abs(gray1 - gray2);

    if (diff > 20) {
      output.data[i] = 255;     // R
      output.data[i + 1] = 0;   // G
      output.data[i + 2] = 0;   // B
      output.data[i + 3] = 255; // A
    } else {
      output.data[i] = gray1;
      output.data[i + 1] = gray1;
      output.data[i + 2] = gray1;
      output.data[i + 3] = 255;
    }
  }

  outCtx.putImageData(output, 0, 0);
  return outputCanvas.toDataURL();
}
