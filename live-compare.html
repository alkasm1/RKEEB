<canvas id="canvas" width="800" height="400"></canvas>
<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// تحميل الصورة أو الفيديو في canvas
const img = new Image();
img.src = "frame.png"; // لقطة فيديو أو صورة تمثل المواد
img.onload = () => {
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  analyze();
};

function extractBoxes(canvas, side = "left") {
  const boxes = [];
  const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const boxSize = 80;
  const step = 40;
  const half = canvas.width / 2;

  const startX = side === "left" ? 0 : half;

  for (let y = 0; y < canvas.height - boxSize; y += step) {
    for (let x = startX; x < startX + half - boxSize; x += step) {
      boxes.push({ x, y });
    }
  }
  return boxes;
}

function getBoxData(x, y) {
  return ctx.getImageData(x, y, 80, 80).data;
}

function calculateScore(data1, data2) {
  let sum = 0;
  for (let i = 0; i < data1.length; i += 4) {
    const diff =
      Math.abs(data1[i] - data2[i]) + // Red
      Math.abs(data1[i + 1] - data2[i + 1]) + // Green
      Math.abs(data1[i + 2] - data2[i + 2]);  // Blue
    sum += diff;
  }
  return sum;
}

function drawMatchBoxes(leftBox, rightBox) {
  // يسار
  ctx.strokeStyle = "#00ff00";
  ctx.lineWidth = 3;
  ctx.strokeRect(leftBox.x, leftBox.y, 80, 80);

  // يمين
  ctx.strokeStyle = "#ff0000";
  ctx.strokeRect(rightBox.x, rightBox.y, 80, 80);

  // عرض النسبة التقريبية
  ctx.font = "16px Arial";
  ctx.fillStyle = "#00ff00";
  ctx.fillText("✓", leftBox.x + 5, leftBox.y + 20);

  ctx.fillStyle = "#ff0000";
  ctx.fillText("✓", rightBox.x + 5, rightBox.y + 20);
}

function analyze() {
  const leftBoxes = extractBoxes(canvas, "left");
  const rightBoxes = extractBoxes(canvas, "right");

  let bestScore = Infinity;
  let bestMatch = {};

  for (const left of leftBoxes) {
    const data1 = getBoxData(left.x, left.y);
    for (const right of rightBoxes) {
      const data2 = getBoxData(right.x, right.y);
      const score = calculateScore(data1, data2);
      if (score < bestScore) {
        bestScore = score;
        bestMatch = { left, right };
      }
    }
  }

  drawMatchBoxes(bestMatch.left, bestMatch.right);
  console.log("أفضل تطابق:", bestScore);
}
</script>
