<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>وحدة التحقق البصري</title>
  <style>
    body { background:#111; color:#fff; text-align:center; font-family:sans-serif }
    canvas { border:1px solid #ccc; margin-top:10px }
    #controls { margin:20px }
    button { padding:10px 20px; font-size:16px }
  </style>
</head>
<body>
  <h2>📷 وحدة التحقق البصري الحي</h2>
  <video id="video" autoplay muted playsinline style="display:none;"></video>
  <canvas id="canvas" width="640" height="480"></canvas>
  <div id="controls">
    <button onclick="verifyDirect()">تحقق مباشر</button>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let regions = [];

    function drawOverlays() {
      const regionWidth = 150;
      const regionHeight = 150;
      const y = (canvas.height - regionHeight) / 2;
      const gap = 20;
      const center = canvas.width / 2;

      regions = [
        { x: center - regionWidth - gap / 2, y: y, w: regionWidth, h: regionHeight },
        { x: center + gap / 2, y: y, w: regionWidth, h: regionHeight }
      ];

      ctx.strokeStyle = 'rgba(0,255,0,0.8)';
      ctx.lineWidth = 2;

      regions.forEach(r => ctx.strokeRect(r.x, r.y, r.w, r.h));
    }

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        video.srcObject = stream;
        requestAnimationFrame(updateFrame);
      }).catch(err => console.error('Camera error:', err));
    }

    function updateFrame() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      drawOverlays();
      requestAnimationFrame(updateFrame);
    }

    function verifyDirect() {
      // تحليل مباشر لمحتوى المربعين داخل الفيديو الحي
      const imageDataA = ctx.getImageData(regions[0].x, regions[0].y, regions[0].w, regions[0].h);
      const imageDataB = ctx.getImageData(regions[1].x, regions[1].y, regions[1].w, regions[1].h);

      // مثال أولي على مقارنة البكسلات - يمكن استبداله بخوارزميات أدق لاحقًا
      const diff = compareImages(imageDataA, imageDataB);
      alert(diff < 0.1 ? '✅ المستندان متطابقان تقريبًا' : '❌ هناك فروقات واضحة');
    }

    function compareImages(dataA, dataB) {
      let diff = 0;
      for (let i = 0; i < dataA.data.length; i += 4) {
        const da = dataA.data;
        const db = dataB.data;
        diff += Math.abs(da[i] - db[i]) + Math.abs(da[i+1] - db[i+1]) + Math.abs(da[i+2] - db[i+2]);
      }
      return diff / dataA.data.length / 255;
    }

    window.onload = startCamera;
  </script>
</body>
</html>
