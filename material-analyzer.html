<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>أداة تحليل المادة</title>
  <style>
    body { font-family: sans-serif; direction: rtl; }
    canvas { border: 1px solid #888; margin: 10px; }
    .zone { display: flex; justify-content: space-around; flex-wrap: wrap; }
    button { margin: 5px; padding: 10px; }
  </style>
</head>
<body>
  <h2>تحليل نسيجي لمادتين في نفس الصورة</h2>
  <video id="video" width="320" height="240" autoplay></video>
  <button onclick="capture()">📸 تصوير مباشر</button>
  <canvas id="sourceCanvas" width="320" height="240"></canvas>
  <div class="zone">
    <canvas id="region1" width="100" height="100"></canvas>
    <canvas id="region2" width="100" height="100"></canvas>
  </div>
  <button onclick="analyze()">🔍 تحليل ومطابقة</button>
  <p id="result">نتيجة التحليل: </p>

  <script>
    const video = document.getElementById('video');
    const sourceCanvas = document.getElementById('sourceCanvas');
    const region1 = document.getElementById('region1');
    const region2 = document.getElementById('region2');
    const result = document.getElementById('result');

    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
    });

    function capture() {
      sourceCanvas.getContext('2d').drawImage(video, 0, 0, sourceCanvas.width, sourceCanvas.height);
      result.textContent = "📌 تم التقاط الصورة. اختر منطقتين للتحليل.";
    }

    sourceCanvas.addEventListener('click', function(e) {
      const rect = sourceCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const context = sourceCanvas.getContext('2d');
      const imageData = context.getImageData(x - 50, y - 50, 100, 100);
      if (!region1.dataset.filled) {
        region1.getContext('2d').putImageData(imageData, 0, 0);
        region1.dataset.filled = "true";
      } else {
        region2.getContext('2d').putImageData(imageData, 0, 0);
        region2.dataset.filled = "";
      }
    });

    function analyze() {
      const data1 = region1.getContext('2d').getImageData(0, 0, 100, 100).data;
      const data2 = region2.getContext('2d').getImageData(0, 0, 100, 100).data;

      let diff = 0;
      for (let i = 0; i < data1.length; i += 4) {
        const gray1 = (data1[i] + data1[i + 1] + data1[i + 2]) / 3;
        const gray2 = (data2[i] + data2[i + 1] + data2[i + 2]) / 3;
        diff += Math.abs(gray1 - gray2);
      }

      const avgDiff = diff / (data1.length / 4);
      const similarity = Math.max(0, 100 - avgDiff * 0.5);
      result.textContent = `✅ نسبة التشابه النسيجي: ${similarity.toFixed(2)}٪`;
    }
  </script>
</body>
</html>
